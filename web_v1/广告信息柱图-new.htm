
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">


      <script src="echarts.min.js"></script>
      <script src="macarons.js"></script>
      <script src="shine.js"></script>
      <script src="infographic.js"></script>
      <script src="roma.js"></script>
      <script src="dark.js"></script>


  <!-- jQuery / jQuery UI -->
  <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="http://libs.baidu.com/jqueryui/1.10.2/jquery-ui.min.js"></script>
  <!-- jQuery Touch Punch - Enable Touch Drag and Drop -->
  <script src="core/vendor/jquery.touch-punch.min.js"></script>
  <!-- jQuery.Shapeshift -->
  <script src="core/jquery.shapeshift.js"></script>


  <script src="echarts.min.js"></script>
  <script src='elasticsearch-js/elasticsearch.jquery.js' type='text/javascript'></script>


  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  <link rel="stylesheet" href="css/metro.css" />
  
  

  <!-- CSS -->
  <style>
    .body_css {
      font-size: 13px;
    }
    .container {
      border: 1px dashed #CCC;
      position: relative; 
    }

    .container > div {
      background: rgb(27,154,247);
      color: rgb(255,255,255);
      position: absolute;
      height: 25px;
      line-height: 25px;
      text-align: center;
      width: 100px;
    }


    .container > .ss-placeholder-child {
      background: transparent;
      border: 1px dashed blue;
      height: 20px;
    }

  </style>



  <!-- Javascript -->
  <script>
  var JSON_DATA=[
      {
         'text' : 'UU',
         'state' : {
           'opened' : true,'selected' : false
         },
         'children' : [
           { 'text' : 'UU05' ,
             'metadata' : { id : 'UU05' }
           },
           { 'text' : 'UU06' ,
             'metadata' : { id : 'UU06' }
           },
           { 'text' : 'UU07' ,
             'metadata' : { id : 'UU07' }
           },
           { 'text' : 'UU08' ,
             'metadata' : { id : 'UU08' }
           },
           { 'text' : 'UU09' ,
             'metadata' : { id : 'UU09' }
           },
           { 'text' : 'UU10' ,
             'metadata' : { id : 'UU10' }
           },
           { 'text' : 'UU11' ,
             'metadata' : { id : 'UU11' }
           },
           { 'text' : 'UU12' ,
             'metadata' : { id : 'UU12' }
           },
           { 'text' : 'UU13' ,
             'metadata' : { id : 'UU13' }
           },
           { 'text' : 'UU14' ,
             'metadata' : { id : 'UU14' }
           },
           { 'text' : 'UU15' ,
             'metadata' : { id : 'UU15' }
           }
         ]
      },
      {
         'text' : '人口属性',
         'children' : [
           { 'text' : '性别' ,
            'children' :[
              { 'text' : '男' ,
                'metadata' : { id : 'P01010001' }
              },
              { 'text' : '女' ,
              'metadata' : { id : 'P01010002' }
             }]
            },
            { 'text' : '年龄' ,
              'children' :[
              { 'text' : '18岁以下' ,
              'metadata' : { id : 'P01020001' }
              },
              { 'text' : '18-23岁' ,
              'metadata' : { id : 'P01020002' }
              },
              { 'text' : '24-30岁' ,
              'metadata' : { id : 'P01020003' }
              },
              { 'text' : '31-40岁' ,
              'metadata' : { id : 'P01020004' }
              },
              { 'text' : '40-50岁' ,
              'metadata' : { id : 'P01020005' }
              },
              { 'text' : '50岁以上' ,
              'metadata' : { id : 'P01020006' }
              }
             ]
            },
            { 'text' : '收入' ,
              'children' :[
              { 'text' : '2000元以下' ,
              'metadata' : { id : 'P01030001' }
              },
              { 'text' : '2000-5000元' ,
              'metadata' : { id : 'P01030002' }
              },
              { 'text' : '5001-8000元' ,
              'metadata' : { id : 'P01030003' }
              },
              { 'text' : '8001-15000元' ,
              'metadata' : { id : 'P01030004' }
              },
              { 'text' : '15000元以上' ,
              'metadata' : { id : 'P01030005' }
              }
             ]
            }
         ]
      },
      {
         'text' : '上网行为',
         'children' : [
           { 'text' : '使用时间段' ,
              'children' :[
              { 'text' : '上班高峰' ,
              'metadata' : { id : 'N00010001' }
              },
              { 'text' : '上班时间' ,
              'metadata' : { id : 'N00010002' }
              },
              { 'text' : '午休' ,
              'metadata' : { id : 'N00010003' }
              },
              { 'text' : '下班高峰' ,
              'metadata' : { id : 'N00010004' }
              },
              { 'text' : '夜晚休闲' ,
              'metadata' : { id : 'N00010005' }
              },
              { 'text' : '夜猫' ,
              'metadata' : { id : 'N00010006' }
              }
             ]
           },
            { 'text' : '活跃度' ,
              'children' :[
              { 'text' : '极浅度' ,
              'metadata' : { id : 'N00020001' }
              },
              { 'text' : '浅度' ,
              'metadata' : { id : 'N00020002' }
              },
              { 'text' : '中度' ,
              'metadata' : { id : 'N00020003' }
              },
              { 'text' : '深度' ,
              'metadata' : { id : 'N00020004' }
              },
              { 'text' : '极重度' ,
              'metadata' : { id : 'N00020003' }
              }
             ]
           },
           { 'text' : '联网方式' ,
              'children' :[
              { 'text' : 'wifi' ,
              'metadata' : { id : 'N00030001' }
              },
              { 'text' : '4G' ,
              'metadata' : { id : 'N00030002' }
              },
              { 'text' : '3G' ,
              'metadata' : { id : 'N00030003' }
              },
              { 'text' : '2G' ,
              'metadata' : { id : 'N00030004' }
              },
              { 'text' : '其他' ,
              'metadata' : { id : 'N00030005' }
              }
             ]
           },
           { 'text' : '运营商' ,
              'children' :[
              { 'text' : '移动' ,
              'metadata' : { id : 'N00040001' }
              },
              { 'text' : '联通' ,
              'metadata' : { id : 'N00040002' }
              },
              { 'text' : '电信' ,
              'metadata' : { id : 'N00040003' }
              }
             ]
           }
         ]
      }
      ]


    $(document).ready(function() {

        var arrs = [{"APPAP":1},{"SSC佛山市":12},{"A04":1},{"N00010006":1},{"N4H010001":1},{"P01020001":1},{"UU05":1},{"P01030001":1},{"UU10":1},{"UU04100012":1},{"P01010001":1},{"SSP广东省":10}];
        // alert(arrs);

        $.each(arrs, function(n, obj){
          for (var key in obj) {
            
          }

          // if(typeof(value.UU04100012) != 'undefined') {
          //   alert(value.UU04100012);
          // }
        });

      

$('#jstree_demo_div').jstree({ 'core' : { // 'data' : JSON_DATA 
    'data' : JSON_DATA 
}
,"plugins" : [ "themes", "json_data", "ui" ]
      }).bind("select_node.jstree", function (e, data) { 

        
        var texts = data.node.original.text
        var context=data.node.original.metadata.id
        console.log(e)
        console.log(data); // 使用开发者工具来查看data的具体格式
        $("#cdtions").append('<div class="operator" title="双击删除">'+texts+':'+context+'\t</div>');

        $(".container").shapeshift(); // 解决新添加的div位置
        $(".operator").bind('dblclick',function(){
          this.remove();
          $(".container").shapeshift();
        });
                
      });

      $(".container").shapeshift();

      $(".button.cycle-button").bind('click',function(event){
        $("#cdtions").append('<div class="operator" style="background: rgb(123,114,233);" title="双击删除">'+$(event.target).text()+'\t</div>');
        $(".container").shapeshift();
        $(".operator").bind('dblclick',function(){
          this.remove();
          $(".container").shapeshift();
      });
      });

      $("#sbmt").bind('click',function(){
        var context= $("#cdtions").text();
        // 去除前面的空格/特殊字符
        var arr=context.replace(/^(\s|\u00A0)+/,'').replace(/(\s|\u00A0)+$/,'').split('\t')  // eg: UU05 and UU03 and ( p0101 or N0204 )
        
        if(arr.length<=1 && arr[0]==''){
          alert("invalid select!")
          return 
        }
          

  var TAG=""  
  var isFirst= false  
  var isOR = false
  var existAND = true
  for (var i=0;i<arr.length;i++){
    var val=arr[i].replace(/(.)+:/,'') 
    if(val=='and' || val=='AND'){
  	   existAND = true
  	   continue;
  	}
  
    if(val=='OR' || val=='or'){
        existAND = false
        continue;
    }
    if(i == 0){
      if (val.indexOf('(')>=0){
        isOR = true
        isFirst =true
      }else{
         TAG = '{"bool":{"should":[{"exists":{"field" : "tags.'+val+'"}}]}}'   //string
      } 
    }else{

      if (val.indexOf('(')>=0){
        isOR = true
        isFirst = true
      }else if(val.indexOf(')')>=0){
        isOR = false
        existAND = true
        TAG = TAG +"]}}"
      }else if(isOR){
        if(isFirst){
        	if(TAG == ''){ // eg: ( UU11 or UU13 )
        		TAG = '{"bool":{"should":[' + '{"exists":{"field" : "tags.'+ val+'"}}'
        	}else{ // UU05 and ( UU11 or UU13 )
            TAG = TAG + "," + '{"bool":{"should":[' + '{"exists":{"field" : "tags.'+ val+'"}}'
          }
         isFirst=false
        }else{
          TAG = TAG + "," +'{"exists":{"field" : "tags.'+ val +'"}}'
        }
      }else{
      	if(existAND){
          TAG = TAG +","+ '{"bool":{"should":[{"exists":{"field" : "tags.'+ val +'"}}]}}'
        }else{ 
        	if(i==2){ // UU11 or UU13
        		TAG = '{"bool":{"should":[' + '{"exists":{"field" : "tags.'+ arr[0].replace(/(.)+:/,'')+'"}}'
        		}
        	TAG = TAG + "," +'{"exists":{"field" : "tags.'+ val +'"}}'
        	if(i==(arr.length-1)){
        	  	TAG = TAG +"]}}"
        	}
      	}
      } 
     }        
   }
   var mc = ',{"bool":{"should":[{"exists":{"field":"tags.UU17*"}}]}}';
   var queryTag= '{"must":[' + TAG + mc + ']}'
   var jsonTag = eval('(' + queryTag + ')');
   //alert("tag==="+queryTag)
   //console.log(jsonTag); 
          
                // elasticsearch.jquery.js  版
   var client = new $.es.Client({
        hosts: 'http://58.61.152.2:9201',
        log: 'trace' //输出详细的调试信息
  });

      // client.ping({
      //   requestTimeout: 3000,

      //   // undocumented params are appended to the query string
      //   hello: "elasticsearch"
      // }, function (error) {
      //   if (error) {
      //     console.error('elasticsearch cluster is down!');
      //   } else {
      //     console.log('All is well');
      //   }
      // });

      client.search({
        index:'tag',type: 'taglib',
        body: {
          query: {
            filtered: {
              filter: {
                  bool:jsonTag
              }
            }
          }
        }
      }).then(function (resp) {
          // alert("resp = "+resp.hits.hits);
          var xAxisValue = [];
          var showValues = []; 
          var clickValues = [];
          var rateValues = [];
          $.each(resp.hits.hits, function(n, obj){
            $.each(obj._source.tags, function(n, obj){
                for (var key in obj) {
                  if (key.substr(0, 'UU04'.length) == 'UU04') {
                    if ($.inArray(key, xAxisValue) == -1) { 
                      xAxisValue.push(key);
                    }
                  }
                }
            });
          });

          xAxisValue = xAxisValue.sort();
          for (var i = 0; i < xAxisValue.length; i++) {
            $.ajax({
              url: 'http://58.61.152.2:9201/_sql?sql=SELECT SUM(tags.'+xAxisValue[i]+') AS sm FROM tag where tags.'+xAxisValue[i]+'>0 and tags.UU06>0',
              type: 'GET',
              data: '',
              // dataType: 'json',
              async: false, // 默认为true 异步
              error: function(err){
                 showValues.push(0);
              },
              success: function(data){
                showValues.push(data.aggregations.sm.value);
              }
            });

            $.ajax({
              url: 'http://58.61.152.2:9201/_sql?sql=SELECT SUM(tags.'+xAxisValue[i]+') AS sm FROM tag where tags.'+xAxisValue[i]+'>0  and tags.UU07>0',
              type: 'GET',
              data: '',
              // dataType: 'json',
              async: false, // 默认为true 异步
              error: function(err){
                clickValues.push(0);
              },
              success: function(data){
                clickValues.push(data.aggregations.sm.value);
              }
            });

            if (parseInt(showValues[i])>0){
              rateValues.push((clickValues[i]/showValues[i]).toFixed(2));
            } else {
              rateValues.push(0);
            }
          }
          alert(xAxisValue + " === " +showValues + " == "+clickValues + " === "+ rateValues);
          option01.xAxis[0].data = xAxisValue;
          option01.series[0].data = showValues;
          option01.series[1].data = clickValues;
          option01.series[2].data = rateValues;

    		  myChart01.setOption(option01, true);  				
          console.log(resp)
      }, function (err) {
          console.trace(err.message);
      }); 
    
    });
    })
  </script>
</head>
<body class="body_css">
<table border="0" width="100%;">
  <tr>
    <td width="15%"><div id="jstree_demo_div"></div></td>
    <td width="85%">
    <div class="container" id='cdtions'></div>

    <div align="center">
      <button class="button cycle-button" style="background: rgb(123,114,233); color: rgb(255,255,255);" >AND</button>&nbsp;
      <button class="button cycle-button" style="background: rgb(123,114,233); color: rgb(255,255,255);" >OR</button>&nbsp;
     <!-- <button class="button cycle-button" style="background: rgb(123,114,233); color: rgb(255,255,255);" >NOT</button>&nbsp;
     -->
      <button class="button cycle-button" style="background: rgb(123,114,233); color: rgb(255,255,255);" >(</button>&nbsp;
      <button class="button cycle-button" style="background: rgb(123,114,233); color: rgb(255,255,255);" >)</button>&nbsp;&nbsp;&nbsp;&nbsp;
      <button id='sbmt' class="button primary">提交</button>
    </div>
    </td>
  </tr>
</table>

    <!-- 为 ECharts 准备一个具备大小（宽高）的Dom -->
    <div id="myChart01" style="width: 100%;height:540px; float: left;" ></div>
    <script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
        var myChart01 = echarts.init(document.getElementById('myChart01'));
        var option01 = {
            tooltip: {
                trigger: 'axis'
            },
            toolbox: {
                feature: {
                    dataView: {show: true, readOnly: false},
                    magicType: {show: true, type: ['line', 'bar']},
                    restore: {show: true},
                    saveAsImage: {show: true}
                }
            },
            legend: {
                data:['展示数','点击数','点击率']
            },
            xAxis: [
                {
                    type: 'category',
                    data: ['UU04100002']
                }
            ],
            yAxis: [
                {
                    type: 'value',
                    name: '数量',
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLabel: {
                        formatter: '{value} 次'
                    }
                },
                {
                    type: 'value',
                    name: '点击率',
                    min: 0,
                    max: 100,
                    interval: 5,
                    axisLabel: {
                        formatter: '{value} %'
                    }
                }
            ],
            series: [
                {
                    name:'展示数',
                    type:'bar',
                    data: [0]
                },
                {
                    name:'点击数',
                    type:'bar',
                    data: [0]
                },
                {
                    name:'点击率',
                    type:'line',
                    yAxisIndex: 1,
                    data:[0]
                }
            ]
        };
        // 使用刚指定的配置项和数据显示图表。
        myChart01.setOption(option01);
        

     </script>


  </body>
</html>